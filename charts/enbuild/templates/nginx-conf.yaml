apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ .Release.Name }}-nginx-conf
  labels:
{{- include "enbuild-helm-chart.labels" . | nindent 4 }}
data:
  default.conf: |-

    map $http_upgrade $connection_upgrade {
      default upgrade;
      '' close;
    }
    
    server {
      listen 8080 default_server;
      server_name _;
      proxy_pass_header Authorization;
      proxy_set_header Host $host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-Forwarded-Proto $scheme;

      location /enbuild-bk/ {
        proxy_pass http://{{ .Release.Name }}-enbuild-backend/;
      }

      location /enbuild-user/ {
        proxy_pass http://{{ .Release.Name }}-enbuild-user/;
      }

{{- if .Values.enbuildMl.enabled }}

      location /enbuild-ml/ {
        proxy_pass http://{{ .Release.Name }}-enbuild-ml/;
      }
      {{- if .Values.jupyterhub.cull.enabled }}
      location /jupyter/ {
          proxy_pass http://proxy-public/jupyter/;
          proxy_redirect /hub/ /jupyter/hub/;
          proxy_cookie_path /hub/ /jupyter/hub/;
          sub_filter 'href="/hub/' 'href="/jupyter/hub/';
          sub_filter 'src="/hub/' 'src="/jupyter/hub/';
          sub_filter_once off;
      }
      {{- end }}
{{- end }}

{{- if .Values.enbuildAI.enabled }}

      location /enbuild-ai/ {
        proxy_pass http://{{ .Release.Name }}-enbuild-ai/;
      }

      location = /auth-check {
          internal;
          proxy_pass http://{{ .Release.Name }}-enbuild-user/api/v1/roles/auth;

          # Force method = GET
          proxy_pass_request_body off;
          proxy_set_header Content-Length "";

          # Include session info
          proxy_set_header Authorization $http_authorization;
          proxy_set_header Cookie $http_cookie;
      }

      location /headlamp/ {
        auth_request /auth-check;
        error_page 401 = /;
        # Block requests that do not include this header
        # if ($http_x_from_ui != "true") {
        #   return 403;
        # }
        proxy_pass http://headlamp.kube-system.svc.cluster.local/headlamp/;
      }

{{- end }}

{{- if .Values.global.monitoring.enabled }}

      location /grafana/ {
        proxy_pass http://{{ .Release.Name }}-grafana/;
        rewrite ^/grafana/(.*) /$1 break;
     }
{{- end }}
    }